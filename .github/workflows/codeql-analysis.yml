name: "CodeQL"

on:
  push:
    branches: [main]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [main]
    
concurrency: 
  group: ${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-backend:
    name: build backend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # We must fetch at least the immediate parents so that if this is
          # a pull request then we can checkout the head.
          fetch-depth: 2

      - name: Setup dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Build API
        run: dotnet build AnniversariesApi.sln -o _output
        
      - name: Upload Backend Output
        uses: actions/upload-artifact@v3.1.2
        with:
          # Artifact name
          name: backend-output
          # A file, directory or wildcard pattern that describes what to upload
          path: _output
          # The desired behavior if no files are found using the provided path.
          if-no-files-found: error
          # Duration after which artifact will expire in days. 0 means using default retention.
          retention-days: 1
        
  build-frontend:
    name: build frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # We must fetch at least the immediate parents so that if this is
          # a pull request then we can checkout the head.
          fetch-depth: 2

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: '14'

      - run: npm install
        working-directory: Anniversaries.Web

      - run: npm run build
        working-directory: Anniversaries.Web
        
      - name: Upload Frontend Output
        uses: actions/upload-artifact@v3.1.2
        with:
          # Artifact name
          name: frontend-output
          # A file, directory or wildcard pattern that describes what to upload
          path: Anniversaries.Api/wwwroot
          # The desired behavior if no files are found using the provided path.
          if-no-files-found: error
          # Duration after which artifact will expire in days. 0 means using default retention.
          retention-days: 1

  analyse:
    name: Analyse
    runs-on: ubuntu-latest
    needs: 
      - build-backend
      - build-frontend

    steps:
      # Initializes the CodeQL tools for scanning.
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        # Override language selection by uncommenting this and choosing your languages
        # with:
        #   languages: go, javascript, csharp, python, cpp, java

      #- name: Download backend build output
      #  uses: actions/download-artifact@v3.0.0
      #  with:
      #    # Artifact name
      #    name: backend-output
      #    # Destination path
      #    path: src/backend

      #- name: Download frontend build output
      #  uses: actions/download-artifact@v3.0.0
      #  with:
      #    # Artifact name
      #    name: frontend-output
      #    # Destination path
      #    path: src/frontend
          
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          # We must fetch at least the immediate parents so that if this is
          # a pull request then we can checkout the head.
          fetch-depth: 2

      - name: Install Node
        uses: actions/setup-node@v3
        with:
          node-version: '14'

      - run: npm install
        working-directory: Anniversaries.Web

      - run: npm run build
        working-directory: Anniversaries.Web

      - name: Setup dotnet
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '6.0.x'

      - name: Build API
        run: dotnet build AnniversariesApi.sln -o _output

      # ‚ÑπÔ∏è Command-line programs to run using the OS shell.
      # üìö https://git.io/JvXDl

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v2
